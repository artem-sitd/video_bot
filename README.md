# Video Analytics Telegram Bot

–¢–µ—Å—Ç–æ–≤–æ–µ –∑–∞–¥–∞–Ω–∏–µ –ø–æ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –≤–∏–¥–µ–æ –∏ –∑–∞–º–µ—Ä–∞–º–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏.

–ü—Ä–æ–µ–∫—Ç —Ä–µ–∞–ª–∏–∑—É–µ—Ç Telegram-–±–æ—Ç–∞, –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –≤–æ–ø—Ä–æ—Å—ã –Ω–∞ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ–º —è–∑—ã–∫–µ (RU), –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç –∏—Ö –≤ —Ñ–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π –ø–ª–∞–Ω –∑–∞–ø—Ä–æ—Å–∞ –∏ –≤—ã–ø–æ–ª–Ω—è–µ—Ç –∞–≥—Ä–µ–≥–∞—Ü–∏–∏ –ø–æ –¥–∞–Ω–Ω—ã–º –≤ PostgreSQL.

---

## üß† –û–±—â–∞—è –∏–¥–µ—è

–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∞ –ø–æ –ø—Ä–∏–Ω—Ü–∏–ø—É **LLM ‚Üí QueryPlan ‚Üí SQLAlchemy**:

1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–¥–∞—ë—Ç –≤–æ–ø—Ä–æ—Å –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ
2. LLM (OpenAI) –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç —Ç–µ–∫—Å—Ç –≤ **—Å—Ç—Ä–æ–≥–æ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–π JSON-–ø–ª–∞–Ω –∑–∞–ø—Ä–æ—Å–∞** (`QueryPlan`)
3. –ü–ª–∞–Ω –≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç—Å—è —á–µ—Ä–µ–∑ **Pydantic**
4. –ù–∞ –æ—Å–Ω–æ–≤–µ –ø–ª–∞–Ω–∞ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ —Å—Ç—Ä–æ–∏—Ç—Å—è SQL-–∑–∞–ø—Ä–æ—Å
5. –†–µ–∑—É–ª—å—Ç–∞—Ç –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é

LLM **–Ω–µ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç SQL –Ω–∞–ø—Ä—è–º—É—é**, –∞ –ª–∏—à—å –æ–ø–∏—Å—ã–≤–∞–µ—Ç *—á—Ç–æ* –Ω—É–∂–Ω–æ –ø–æ—Å—á–∏—Ç–∞—Ç—å, –∞ *–∫–∞–∫* ‚Äî —Ä–µ—à–∞–µ—Ç —Å–µ—Ä–≤–µ—Ä–Ω–∞—è –ª–æ–≥–∏–∫–∞.

---

## üì¶ –°—Ç–µ–∫ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π

- Python 3.12
- aiogram (Telegram Bot API)
- SQLAlchemy (async)
- PostgreSQL
- Pydantic v2
- OpenAI API (—á–µ—Ä–µ–∑ HTTP/SOCKS proxy)
- Alembic (–º–∏–≥—Ä–∞—Ü–∏–∏)

---

## üóÇÔ∏è –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
video_bot/
‚îú‚îÄ‚îÄ bot/
‚îÇ   ‚îú‚îÄ‚îÄ main.py          # —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –±–æ—Ç–∞
‚îÇ   ‚îî‚îÄ‚îÄ handlers.py      # –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
‚îú‚îÄ‚îÄ db/
‚îÇ   ‚îú‚îÄ‚îÄ models.py        # SQLAlchemy –º–æ–¥–µ–ª–∏
‚îÇ   ‚îú‚îÄ‚îÄ session.py       # 2 —Å–µ—Å—Å–∏–∏. 1 async –¥–ª—è –±–æ—Ç–∞ 2 sync –¥–ª—è load_json –∏ –º–∏–≥—Ä–∞—Ü–∏–π
‚îÇ   ‚îú‚îÄ‚îÄ queries.py       # –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ QueryPlan
‚îÇ   ‚îî‚îÄ‚îÄ base.py          # —ç–∫–∑–µ–º–ø–ª—è—Ä DeclarativeBase
‚îú‚îÄ‚îÄ llm/
‚îÇ   ‚îú‚îÄ‚îÄ client.py        # OpenAI client
‚îÇ   ‚îú‚îÄ‚îÄ prompt.py        # system prompt
‚îÇ   ‚îî‚îÄ‚îÄ schemas.py       # Pydantic —Å—Ö–µ–º—ã (QueryPlan)
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îú‚îÄ‚îÄ dispatcher.py    # –¥–∏—Å–ø–µ—Ç—á–µ—Ä –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤
‚îÇ   ‚îî‚îÄ‚îÄ clean_response   # –æ—á–∏—Å—Ç–∫–∞ –æ—Ç–≤–µ—Ç–∞ –æ—Ç llm –æ—Ç –º—É—Å–æ—Ä–∞
‚îú‚îÄ‚îÄ config.py            # –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ–µ–∫—Ç–∞
‚îú‚îÄ‚îÄ alembic/             # –º–∏–≥—Ä–∞—Ü–∏–∏ –ë–î
‚îî‚îÄ‚îÄ README.md
```

---

## üìÑ QueryPlan (–∫–ª—é—á–µ–≤–∞—è –∫–æ–Ω—Ü–µ–ø—Ü–∏—è)

LLM –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç JSON —Å—Ç—Ä–æ–≥–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ –≤–∏–¥–∞:

```json
{
  "source": "videos | snapshots",
  "select": {
    "type": "aggregate",
    "func": "count | sum",
    "field": "id | creator_id | views_count | delta_views_count | video_created_at",
    "distinct": true
  },
  "filters": [
    {
      "field": "created_at | video_created_at | creator_id | views_count | delta_views_count",
      "op": "= | > | < | >= | <= | between",
      "value": "..."
    }
  ]
}
```

### –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è (–ø—Ä–∏–Ω—Ü–∏–ø–∏–∞–ª—å–Ω–æ):

- ‚ùå –Ω–µ—Ç –≤–ª–æ–∂–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- ‚ùå –Ω–µ—Ç JOIN'–æ–≤ –æ—Ç LLM
- ‚ùå –Ω–µ—Ç –ø–æ–¥–∑–∞–ø—Ä–æ—Å–æ–≤ –≤ —Ñ–∏–ª—å—Ç—Ä–∞—Ö
- ‚ùå –Ω–µ—Ç raw SQL –æ—Ç LLM

–≠—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ—Å—Ç—å.

---

## üîç –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ç–∏–ø—ã –∑–∞–ø—Ä–æ—Å–æ–≤

–ü—Ä–∏–º–µ—Ä—ã –≤–æ–ø—Ä–æ—Å–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è:

- –°–∫–æ–ª—å–∫–æ –≤–∏–¥–µ–æ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ –∑–∞ –ø–µ—Ä–∏–æ–¥
- –°–∫–æ–ª—å–∫–æ —Ä–∞–∑–Ω—ã—Ö –∫—Ä–µ–∞—Ç–æ—Ä–æ–≤ –∏–º–µ—é—Ç –≤–∏–¥–µ–æ —Å > N –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤
- –°—É–º–º–∞—Ä–Ω—ã–π –ø—Ä–∏—Ä–æ—Å—Ç –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤ –∑–∞ –ø–µ—Ä–∏–æ–¥
- –°—É–º–º–∞—Ä–Ω—ã–µ –ø—Ä–æ—Å–º–æ—Ç—Ä—ã –≤–∏–¥–µ–æ, –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω—ã—Ö –≤ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–π –º–µ—Å—è—Ü
- –ü–æ–¥—Å—á—ë—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∫–∞–ª–µ–Ω–¥–∞—Ä–Ω—ã—Ö –¥–Ω–µ–π –ø—É–±–ª–∏–∫–∞—Ü–∏–π
- –ê–Ω–∞–ª–∏–∑ –∑–∞–º–µ—Ä–æ–≤ (snapshots) —Å —É—á—ë—Ç–æ–º –≤—Ä–µ–º–µ–Ω–∏

–í—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è —á–µ—Ä–µ–∑ SQLAlchemy.

---

## üåç –†–∞–±–æ—Ç–∞ —á–µ—Ä–µ–∑ proxy

OpenAI API –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ HTTP / SOCKS5 proxy:

```python
http_client = httpx.Client(proxy=settings.PROXY_URL)
client = OpenAI(api_key=..., http_client=http_client)
```

–≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –∏–∑–æ–ª–∏—Ä–æ–≤–∞—Ç—å —Ç—Ä–∞—Ñ–∏–∫ OpenAI –æ—Ç –æ—Å—Ç–∞–ª—å–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (Telegram —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞–ø—Ä—è–º—É—é).

---

## ‚ñ∂Ô∏è –ó–∞–ø—É—Å–∫ –ø—Ä–æ–µ–∫—Ç–∞

1. ```git clone https://github.com/artem-sitd/video_bot.git```
   2. ```cd video_bot```
2. –°–æ–∑–¥–∞–µ–º –≤–∏—Ä—Ç. –æ–∫—Ä—É–∂–µ–Ω–∏–µ
```python3 -m venv venv```
   2. –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –µ–≥–æ
```source venv/bin/activate``` 
3. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
```pip install -r requirements.txt```
4. –ö–æ–ø–∏—Ä—É–µ–º .env
```cp .env.example .env```
5. –°–æ–∑–¥–∞–µ–º –ë–î –≤ postgres –ª—é–±—ã–º –≤–∞—à–∏–º —Å–ø–æ—Å–æ–±–æ–º
```
CREATE DATABASE videos_db;
CREATE USER videos_user WITH PASSWORD '123';
ALTER DATABASE videos_db OWNER TO videos_user;
```
5. –ó–∞–ø–æ–ª–Ω—è–µ–º .env:
   - DB_HOST=localhost 
   - DB_PORT=5432 # —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –ø–æ—Ä—Ç
   - DB_NAME=videos_db # –Ω–∞–∑–≤–∞–Ω–∏–µ –≤–∞—à–µ–π –±–¥
   - DB_USER=videos_user # –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –ø—Ä–∞–≤–∞–º–∏ –Ω–∞ —ç—Ç—É –±–∞–∑—É
   - DB_PASSWORD=123 # –ø–∞—Ä–æ–ª—å –ë–î
   - BOT_TOKEN= # —Ç–æ–∫–µ–Ω —Ç–µ–ª–µ–≥—Ä–∞–º–º –±–æ—Ç–∞
   - OPENAI_API_KEY= # –∫–ª—é—á –æ—Ç –ê–ü–ò [openai](https://platform.openai.com/settings/organization/api-keys)
   - LOGIN= # –ª–æ–≥–∏–Ω –≤–∞—à–µ–≥–æ –ø—Ä–æ–∫—Å–∏
   - PASS= # –ø–∞—Ä–æ–ª—å –≤–∞—à–µ–≥–æ –ø—Ä–æ–∫—Å–∏
   - HOST= # ip –∞–¥—Ä–µ—Å—Å –≤–∞—à–µ–≥–æ –ø—Ä–æ–∫—Å–∏
   - PORT= # –ø–æ—Ä—Ç –≤–∞—à–µ–≥–æ –ø—Ä–æ–∫—Å–∏

6. –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏:
```
alembic revision --autogenerate -m "init tables"
alembic upgrade head
```
7. –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–∫—Ä–∏–ø—Ç –Ω–∞ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ videos.json
```
python3 app/loader/load_json.py
```

8. –ó–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞:
```
python3 bot/main.py
```
---

## üß™ –¢–µ—Å—Ç–æ–≤–æ–µ –∑–∞–¥–∞–Ω–∏–µ

–ü—Ä–æ–µ–∫—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω –≤ —Ä–∞–º–∫–∞—Ö —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –∑–∞–¥–∞–Ω–∏—è.

–û—Å–Ω–æ–≤–Ω–æ–π —Ñ–æ–∫—É—Å:
- –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —è–∑—ã–∫–∞
- —Å—Ç—Ä–æ–≥–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ SQL-–∏–Ω—ä–µ–∫—Ü–∏–π
- –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –Ω–µ—Ç—Ä–∏–≤–∏–∞–ª—å–Ω—ã—Ö –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏—Ö –∫–µ–π—Å–æ–≤

–í—Å–µ –∞–≤—Ç–æ—Ç–µ—Å—Ç—ã –ø—Ä–æ–≤–µ—Ä—è—é—â–µ–π —Å–∏—Å—Ç–µ–º—ã —É—Å–ø–µ—à–Ω–æ –ø—Ä–æ–π–¥–µ–Ω—ã.

---

## ‚ö†Ô∏è –ü—Ä–∏–º–µ—á–∞–Ω–∏—è

- –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–æ–∑–Ω–∞—Ç–µ–ª—å–Ω–æ –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ LLM
- –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ –ª–æ–≥–∏–∫–∏ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç **–Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ —Å–µ—Ä–≤–µ—Ä–∞**, –∞ –Ω–µ —á–µ—Ä–µ–∑ –ø—Ä–æ–º–ø—Ç
- –†–µ—à–µ–Ω–∏–µ –æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ –Ω–∞ —á–∏—Ç–∞–µ–º–æ—Å—Ç—å –∏ –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ—Å—Ç—å, –∞ –Ω–µ –Ω–∞ "–º–∞–≥–∏—á–µ—Å–∫–∏–π" SQL

---

## üë§ –ê–≤—Ç–æ—Ä

Artem Sitd  
Python Backend Developer

